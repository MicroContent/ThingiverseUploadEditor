<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Thingiverse Upload Editor</title>
    <script src="https://cdn.jsdelivr.net/gh/MicroContent/ThingiverseUploadEditor@main/seamlessjs/seamless.child.min.js"></script>
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: whitesmoke;
            border-bottom: 0 solid black;
            display: flex;
            justify-content:center;
            align-items: center;
        }

        /* === Wrapper Styles === */
        .container {
            margin: 3em 10em 3em 10em;
        }

        #FileUpload {
            justify-content: center;
        }

        .wrapper {
            padding: 0.5em;
            box-shadow: 0 1em 2em rgba(0,0,0,0.30), 0 0.6em 0.5em rgba(0,0,0,0.22);
            border-radius: 0.5em;
            background-color: white;
            width: 30em;
            max-height: 25em;
            overflow: auto;
            margin-bottom: 1em;
        }

        /* === Text Input Box === */
        .title {
            letter-spacing: 0.1em;
            text-align: center;
        }

        .form-control {
            margin-top: 0.5em;
        }

        /* === Upload Box === */
        .upload {
            margin: 0.5em;
            height: auto;
            border: 0.5em dashed #EDEDED;
            display: flex;
            flex-flow: row wrap;
            justify-content: center;
            align-items: center;
            border-radius: 0.3em;
        }

        .upload p {
            margin-top: 0.5em;
            line-height: 0;
            font-size: 1.3rem;
            color: #0c3214;
            letter-spacing: 0.1em;
        }

        .hint-formats {
            text-align: center;
            width: 80%;
            margin-bottom: 0.5em;
        }

        .upload-button {
            height: 2.3em;
            background-color: #EDEDED;
            box-shadow: 0 0.3em 0.5em rgba(0,0,0,0.22);
            border: 0;
            border-radius: 0.5em;
            padding: 0 0.3em 0 0.5em;
        }
        .upload-button:hover {
            cursor: pointer;
            opacity: 0.8;
        }

        /* === Uploaded Files === */
        .uploaded {
            width: 96%;
            margin: 0.5em;
            padding: 0.5em;
            background-color: #EDEDED;
            border-radius: 0.5em;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: center;
        }
        .file {
            display: flex;
            width: 100%;
            flex-direction: column;
        }
        .file-name {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: baseline;
            width: 95%;
            line-height: 0;
            color: #0c3214;
            font-size: 1.1rem;
            letter-spacing: 0.1em;
        }
        .fa-times:hover {
            cursor: pointer;
            opacity: 0.8;
        }
        .fa-file {
            padding: 0.3em;
            font-size: 1em;
            color: #0c3214;
        }
        .error {
            margin: 0.5em;
            color: red;
        }

        #selectFile {
            display: none;
        }

        .btn {
            width: 4em;
            float: right;
        }


    </style>
</head>
<body>
<!-- Connection establishment and communication-->
<script>
    var parent = window.seamless.connect({
        url: window.location.url,
        allowStyleInjection: true
    });

    parent.receive(function(data) {
       switch (data.type) {
           case 'setContent':
               window.data = data.main[0];
               // todo set content
               init(window.data);
               break;
           case 'getContent':

       }
    });

    window.sendToParent = function (event) {
        if (event) {
            event.preventDefault();
        }
        const data = dataGetter();
        parent.send(data);
        updateLayout();
    }

    function updateLayout() {
        parent.send({
            type: 'updateLayout'
        });
    }

    function dataGetter() { // todo
        const title = document.getElementById('inputTitle')

        return {
            type: 'updateData',
            title: title,
            mediaUrlArray: "fileUrl"
        }
    }

    function init(data) {

    }
</script>


<!-- UI -->
<div class="container">
    <div class="wrapper form-group">
        <h3 class="title">Upload Files </h3><i class="bi bi-info-circle"></i>
        <input id="inputTitle" class="form-control" maxlength="60" aria-labelledby="helpTitle" placeholder="Title" type="text">
        <small class="hint" id="helpTitle">Enter a title for the Thing (max. 60 characters)</small>

        <textarea id="inputDescription" maxlength="200" rows="3"
                  class="form-control"  aria-labelledby="helpDescription" placeholder="Description" type="text"></textarea>
        <small class="hint" id="helpDescription">Add a text to describe the Thing you want to upload to Thingiverse</small>

        <textarea id="inputInstructions" maxlength="200" rows="3"
                  class="form-control"  aria-labelledby="helpInstructions" placeholder="Instructions" type="text"></textarea>
        <small class="hint" id="helpInstructions">Add instructions to the Thing you want to upload to Thingiverse</small>
    </div>

    <div id="FileUpload">
        <div class="wrapper">
            <div class="upload" id="uploadZone">
                <p>Drag files here or <button class="upload-button" onclick="openFileExplorer()">Browse</button></p>
                <input type="file" id="selectFile" multiple>
                <small class="hint-formats">Allowed file formats:<br>stl, obj, thing, scad, amf, dae, 3ds, x3d, blend, ply, dxf, ai, cdr, ps, eps, epsi, sch, brd, jpg, png, gif, svg, txt, doc, docx, mp3, wav, mp4</small>
            </div>
            <div class="error" id="errorMaxFile" style="display: none"></div>
            <div class="error" id="errorFileFormat" style="display: none"></div>
            <p>No. of files: <strong id="nrFiles">0</strong> </p>

            <div id="divUploadItems"></div>
        </div>
    </div>

    <button type="button" class="btn btn-success" onclick="uploadFiles(fileList)">OK</button>
</div>


<!-- == Plugin Logic == -->
<script>

    /* === Event Listeners on UI === */

    document.getElementById('inputTitle').addEventListener('change', (e) => {
        title = e.target.value;
    });

    document.getElementById('inputDescription').addEventListener('change', (e) => {
        description = e.target.value;
    });

    document.getElementById('inputInstructions').addEventListener('change', (e) => {
        instructions = e.target.value;
    });

    document.getElementById('uploadZone').addEventListener('drop', (e) => {
        e.preventDefault();
        let files = e.dataTransfer.files;
        addFiles(files);
    });

    document.getElementById('uploadZone').addEventListener('dragover', (e) => {
        e.preventDefault();
        document.getElementById('uploadZone').style.borderColor = '#A9A9A9';
    });

    document.getElementById('uploadZone').addEventListener('dragleave', (e) => {
        e.preventDefault();
        document.getElementById('uploadZone').style.borderColor = '#EDEDED';
    });

    function openFileExplorer() {
        document.getElementById('selectFile').click();
        document.getElementById('selectFile').onchange = function() {
            let files = document.getElementById('selectFile').files;
            addFiles(files)
        };
    }

    function addFiles(files){
        resetErrors();
        for (const file of files) {
            if (validateFile(file)) {
                fileList.push(file);
                renderUploadItem(file);
            }
        }

        document.getElementById('nrFiles').innerText = fileList.length
    }

    function removeFile(id, filename){
        document.getElementById(id).remove();
        fileList = fileList.filter(file => file.name !== filename);
    }


    function validateFile(file) {
        const errorMsgMax = document.getElementById('errorMaxFile');
        const errorMsgFormat = document.getElementById('errorFileFormat');
        if(!file){
            errorMsgMax.innerText = "Oops! Something went wrong.";
            errorMsgMax.style.display = "block";
            return false;
        } else if (fileList.length >= 10) {
            errorMsgMax.innerText = "You can only upload a maximum of 10 files!";
            errorMsgMax.style.display = "block";
            return false;
        }else if (!checkIfValidFileFormat(file.name)) {
            errorMsgFormat.innerText += `${file.name}: not a valid file format\n`;
            errorMsgFormat.style.display = "block";
            return false;
        }

        return true;
    }

    function resetErrors() {
        const errorMsgMax = document.getElementById('errorMaxFile');
        errorMsgMax.style.display = "none";
        errorMsgMax.innerText = "";

        const errorMsgFormat = document.getElementById('errorFileFormat');
        errorMsgFormat.style.display = "none";
        errorMsgFormat.innerText = "";
    }

    /**
     * Checks if a given filename has a valid format for upload at thingiverse
     * @param filename name (incl. extension) of the file to check
     * @return {boolean}
     */
    function checkIfThingiverseFile(filename) {
        const regex = new RegExp(/[^\s]+(.*?).(stl|obj|thing|scad|amf|dae|3ds|x3d|blend|ply|dxf|ai|cdr|ps|eps|epsi|sch|brd|jpe?g|png|gif|svg|txt|doc|docx)$/)
        return regex.test(filename);
    }

    function checkIfValidFileFormat(filename) {
        const regex = new RegExp(/[^\s]+(.*?).(stl|obj|thing|scad|amf|dae|3ds|x3d|blend|ply|dxf|ai|cdr|ps|eps|epsi|sch|brd|jpe?g|png|gif|svg|txt|doc|docx|mp3|mp4|wav)$/)
        return regex.test(filename)
    }



    function uploadFiles(files) {

        // todo upload depending on file type

        const itemId = createThingiverseItem();

        if (itemId) {
            for (const file of files) {
                const awsInfo = informThingiversePreUpload(file, itemId);
                if (awsInfo){
                    createFileAws(awsInfo);
                }
            }
        }
    }

    /**
     * Synchronous function to create a new item at Thingiverse
     *
     * @return {string|undefined} Returns the itemId when successful and undefined if the response status was not 200
     */
    function createThingiverseItem(){
        if (thingiverseApiToken === undefined || thingiverseApiToken === null || thingiverseApiToken === "") {
            console.log("Missing credentials");
            return;
        }

        const url = "https://api.thingiverse.com/things";
        const item = {
            "name": title,
            "category":category,
            "tags":[],
            "description": description,
            "instructions": instructions,
            "is_wip":true,
            "license":"cc"
        }

        let xhr = new XMLHttpRequest();
        xhr.open('POST', url, false);
        xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");
        xhr.setRequestHeader('Authorization', 'Bearer ' + thingiverseApiToken);
        xhr.send(JSON.stringify(item))

        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            const response = JSON.parse(xhr.response);
            console.log(response);
            return response.id;
        } else {
            console.log("An issue occurred during the creation of the item");
            console.log(xhr.response);
            return undefined;
        }
    }

    /**
     * Synchronous function to inform Thingiverse that you want to attach a file to an item.
     * @async
     * @param file File object that should be uploaded.
     * @param itemId String which identifies the item to which the file should be attached.
     *
     * @return {any|undefined} returns the metadata needed to access the bucket if successful and undefined if status not 200.
     */
    function informThingiversePreUpload(file, itemId){
        if (thingiverseApiToken === undefined || thingiverseApiToken === null || thingiverseApiToken === "") {
            console.log("Missing credentials");
            return;
        }

        const url = `https://api.thingiverse.com/things/${itemId}/files`;
        const body = { "filename": file.name };

        let xhr = new XMLHttpRequest();
        xhr.open('POST', url, false);
        xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");
        xhr.setRequestHeader('Authorization', 'Bearer ' + thingiverseApiToken);
        xhr.send(JSON.stringify(body));

        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            return JSON.parse(xhr.response);
        } else {
            console.log("An issue occurred during file upload to AWS");
            console.log(xhr.response);
            return undefined;
        }
    }

    /**
     * Asynchronous function to upload a given file to the corresponding AWS Bucket.
     * @param awsInfo Metadata needed to access the AWS bucket
     * @param file File object that should be uploaded
     */
    function createFileAws(awsInfo, file){
        const url = awsInfo.action.substring(0, awsInfo.action.length-1);

        let formData = new FormData();
        formData.append('AWSAccessKeyId', awsInfo.fields.AWSAccessKeyId);
        formData.append('bucket', awsInfo.fields.bucket);
        formData.append('key', awsInfo.fields.key);
        formData.append('acl', awsInfo.fields.acl);
        formData.append('success_action_redirect', awsInfo.fields.success_action_redirect);
        formData.append('policy', awsInfo.fields.policy);
        formData.append('signature', awsInfo.fields.signature);
        formData.append('Content-Type', awsInfo.fields["Content-Type"]);
        formData.append('Content-Disposition', awsInfo.fields["Content-Disposition"]);
        formData.append('file', fileList[0]);

        let xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.onreadystatechange = () => {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                const resAws = JSON.parse(xhr.response);
                console.log(resAws);

            } else if (xhr.readyState === XMLHttpRequest.DONE && xhr.status !== 200) {
                // todo: error always occurs - redirect to thingiverse unauthorized
                console.log("Error occurred:");
                console.log(xhr.response)
            }
        }

        xhr.send(formData);
    }

    // todo: inform thingiverse postupload how to get the fileId from the reponse?

    /**
     * Renders HTML elements for a given file
     * @example
     *  <div class="uploaded uploaded--one">
     *      <i class="far fa-file-pdf"></i>
     *      <div class="file">
     *          <div class="file__name">
     *              <p>lorem_ipsum.txt</p>
     *              <i class="fas fa-times"></i>
     *          </div>
     *          <div class="progress">
     *              <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width:100%"></div>
     *          </div>
     *      </div>
     *  </div>
     */
    function renderUploadItem(file){
        let fullName = file.name;
        let split = fullName.split('.');
        let extension = split[split.length-1];
        let shortenedName = split[0].substring(0, 13);

        let divUploaded = document.createElement('div');
        divUploaded.classList.add('uploaded')
        divUploaded.id = 'uploaded-'+fullName;

        let icon = document.createElement('i');
        icon.classList.add('far', 'fa-file');
        let divFile = document.createElement('div');
        divFile.classList.add('file');
        let divFileName = document.createElement('div');
        divFileName.classList.add('file-name');
        let pName = document.createElement('p');
        pName.innerText = shortenedName + '...' + extension;
        let iconClose = document.createElement('i');
        iconClose.id = 'icon-close-'+fullName;
        iconClose.classList.add('fas', 'fa-times');
        iconClose.onclick = () => removeFile(divUploaded.id, fullName);

        divFileName.append(pName, iconClose)

        let divProgress = document.createElement('div');
        divProgress.classList.add('progress');
        let divProgressbar = document.createElement('div');
        divProgressbar.classList.add("progress-bar", "bg-success", "progress-bar-striped", "progress-bar-animated")
        divProgressbar.style.width = "60%" // todo sets percentage
        divProgressbar.id = "progress-"+fullName;
        divProgress.appendChild(divProgressbar);
        let pError = document.createElement('p');
        pError.classList.add('error');
        pError.id = 'error-'+fullName;

        divFile.append(divFileName, divProgress, pError)

        divUploaded.append(icon, divFile);

        document.getElementById('divUploadItems').append(divUploaded);
    }

    let fileList = [];
    let title = "";
    let category ="Learning";
    let description ="";
    let instructions ="";
    let thingiverseApiToken;
    init();

</script>

</body>
</html>
